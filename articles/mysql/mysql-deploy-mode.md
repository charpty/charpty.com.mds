## 几种常见的部署模式概要
```mysql```作为互联网常用的数据存储容器，有多种部署的模式，每种模式都各有优劣，根据不同的业务场景使用，因为是个人简单总结下而已就不做图了，看文字想图吧。

### 单库
在业务发展的初期，业务量很小、请求并发数很低的情况，只要使用一个库足以支撑整个业务应用。

### 读写分离
当大量的业务请求使得```mysql```性能达到瓶颈，此时我们可以将业务应用对数据的```读```和```写```操作进行分离，使用```master```节点支撑应用的```写```请求，使用```slave```节点为应用提供```读```请求。因为大多数情况下，应用的请求都是以```读```请求为主，增加了多个```slave```节点可以有效的提供应用读性能。

多个节点之间的表结构和数据都是一模一样的，```slave```节点的数据和表结构都是从```master```节点复制而来。

读写分离又称为分组，何时才需要进行分组是架构师需要提前考虑的，一般来说有上百万数据的时候就可以提前做好分组架构，实际上多少数据需要分组则是根据业务情况来的，如果是业务非常查询非常的复查，那么数据量很小的时候可能就需要分组了。

架构设计决不能脱离业务。

### 分片
当业务数据量变得庞大时，不仅查询性能受到影响，甚至单个实例已经没有足够空间存储时，就需要考虑分片模式了，分片分为分表和分库两种方式，可以单独使用其中一种也可以同时使用。

一般来说推荐使用分库，分表的话数据还是存储在同一个库上，使用相同的CPU、内存等系统资源。当业务量达到了这个数量级，一台服务器肯定是跑满了，还继续在这个服务器进行分表意义不大。另外分库在数据迁移，扩容等操作上都比分表方便的多。

使用分片模式时，各个库或表的数据结构是一样的，但是数据各不相同，应用在对数据库进行查询的时候首先需要通过路由找到数据落在哪个数据库实例上，再在该实例里执行```SQL```查询。分片导致各个实例库数据不同，这也引发了诸多的数据查询策略和技巧。

路由的算法常见的有范围法（规定某一段ID存储在某个实例上）、hash法、一致性hash等，但是这些简单的路由算法都只能通过某一个条件定位到其中一个库，当需要复杂的跨库操作时则就需要业务应用进行复杂处理或者依赖于成熟的分布式数据库中间件了。

### 垂直切分
垂直切分其实将一个表中的多列字段拆开来分别放到不同的表或库中。

在设计表结构时，往往有字段访问频率是比较高的，有些字段几乎是很少查询的，又或者是某些字段是比较短的且常访问的，有的字段是很长的但很少访问，此时可以将这两种字段拆开来放在不同的表里和不同的库里。这样的好处是减小了热点表的体积，方便```mysql```的高速缓存进行结果缓存来提供性能，也使得修改大字段等比较耗时的请求不要影响热点表的查询性能。另外由于```InnoDB```的存储特性，减少数据行长度也是对查询性能非常有利的。    
比如用户的基本信息是一登录就要查询的，并发量非常高，而用户的扩展信息则是要用户在编辑个人信息时才弹出，此时进行拆分就很有必要，往往用户更新下几百字的个人介绍是比较慢的请求（相对而言），我们不希望它降低登录查询的性能。

垂直切分时各个表或库中的表结构不一样，数据也是不一样的，当然他们必须有一个互相联系的字段，一般都是用户ID等。在分表切分时，代码里可以固定好查哪个表就行，但在分库模式下就比较死板和危险了，必须先知道在哪个库，这导致数据库和业务进行了强耦合，在架构设计时要慎重。

#### 分类治之思想！
垂直切分由于和业务有强耦合关系，一般很少会选择跨库的设计，这使得其实它用处不太，但是它的思想我觉得是处理数据库查询性能的关键。

将热点数据和冷数据分离，将关键应用和边缘应用所用的数据库分离，将并发量高的应用和没啥并发用户少的应用所用的数据库分离，这给数据安全与查询性能带来了巨大的提升。

比如说你有两个应用，一个是给千万级用户使用的手机APP，一个是给运营和老板们看看报表的后台管理应用，如果你放一个库，哪天你们几个老总一起查查这一年共增加了多少用户，结果弄的```mysql```CPU 90%，导致APP用户们体验极差，甚至没响应了，用户都跑了，这恐怕老板看到这个报表一秒就打开他也高兴不起来。

正确的做法是区别对待，运营和老板看的应用用个一般的单库都行，但是APP应用一定要用足够好的分布式数据库保障好，运营后台看的数据30秒能跳出来就行了（TM估计老板要打人了），两个库之间可以通过同步工具让数据保持一致就行，这个运营用的单库是只读的，即使被搞坏了也没关系。  

区别对待还有个大好处，由于只用于单个场景，特殊的场景还是可以有特殊处理办法。比如每天增加了多少用户，老板要没过一分钟就来看一次吗，顶多一两个小时看个一次，此时可以通过定时任务提前就加工好数据，数据虽不及时，但人家根本没那么个要求，增加了1000个用户和增加了1001个用户在一般情况都是一样的。  

### 模式结合
其实几个模式并不冲突，可以相互结合，在许多互联网场景中，不仅读并发高而且数据量也很大，此时就可以采用分组与分片结合的方式，分片解决数据量大、写性能的问题，读写分离解决读并发高的问题，这也是典型的应用场景。
采用分表垂直切分时，完全可以与分片、分组结合毫不冲突。

这些只是常见的部署模式，具体的模式只能架构师结合实际的业务场景来决定。


## 扩展与容灾问题
前面说了几种部署的模式，那么他们

## 分片查询问题解决
全局ID、路由

### mapping表

### 特殊ID生成

### 全表全库

### XA事务

## 


>> 参考燕十八的《MySQL高性能优化》、《高性能MySQL》、沈剑的《谈数据库架构典型设计》
